# .github/workflows/scrape.yml
name: Scrape APCHQ Holidays

on:
  schedule:
    - cron: '0 9 1 */3 *'  # Tous les 3 mois
  workflow_dispatch:  # ExÃ©cution manuelle

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write    # Pour crÃ©er des releases
      packages: write   # Pour les artifacts
      actions: read     # Pour lire les actions
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 openpyxl lxml
        
    - name: Run scraping script
      run: python get_apchq_holidays.py
      
    - name: Check if file exists
      run: |
        if [ -f "conges_apchq.xlsx" ]; then
          echo "âœ… Fichier Excel crÃ©Ã© avec succÃ¨s"
          ls -la conges_apchq.xlsx
        else
          echo "âŒ Fichier Excel non trouvÃ©"
          exit 1
        fi
      
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d_%H-%M')" >> $GITHUB_OUTPUT
      
    - name: Upload artifact (sauvegarde)
      uses: actions/upload-artifact@v4
      with:
        name: conges-apchq-${{ steps.date.outputs.date }}
        path: conges_apchq.xlsx
        retention-days: 90
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: release-${{ steps.date.outputs.date }}
        name: CongÃ©s APCHQ - ${{ steps.date.outputs.date }}
        body: |
          ğŸ“… Mise Ã  jour automatique des congÃ©s APCHQ
          ğŸ• GÃ©nÃ©rÃ© le: ${{ steps.date.outputs.date }}
          ğŸ”— Fichier Excel disponible en tÃ©lÃ©chargement
          
          Pour utiliser dans Power Automate:
          ```
          https://api.github.com/repos/${{ github.repository }}/releases/latest
          ```
        files: conges_apchq.xlsx
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
